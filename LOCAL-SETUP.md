# Local Development Setup

This guide will help you set up the CKAD Platform for local testing using Docker (via Rancher Desktop or Docker Desktop).

## Prerequisites

- Docker installed and running (via Rancher Desktop, Docker Desktop, or native Docker)
- Docker Compose (usually included with Docker)
- At least 8GB RAM available for Docker
- Ports 3000 and 3001 available

## Quick Start

1. **Clone the repository** (if not already done):
   ```bash
   git clone <your-repo-url>
   cd Kind
   ```

2. **Create environment file**:
   ```bash
   cp backend/env.example .env
   ```

3. **Edit `.env` file** (optional for basic testing):
   ```bash
   # For local development, you can use default values
   # Only edit if you need Google OAuth or email functionality
   ```

4. **Run the setup script**:
   ```bash
   chmod +x scripts/local-setup.sh
   ./scripts/local-setup.sh
   ```

   Or manually:
   ```bash
   # Build and start services
   docker-compose -f docker-compose.local.yml up -d --build
   
   # Initialize database
   docker-compose -f docker-compose.local.yml exec backend node src/db/seed.js
   ```

5. **Access the application**:
   - Frontend: http://localhost:3000
   - Backend API: http://localhost:3001
   - Health Check: http://localhost:3001/healthz

## Environment Variables

Create a `.env` file in the root directory with these variables:

```env
# Server Configuration
NODE_ENV=development
PORT=3001
FRONTEND_URL=http://localhost:3000

# JWT Secrets (auto-generated by setup script)
JWT_SECRET=dev-jwt-secret-change-me
JWT_REFRESH_SECRET=dev-refresh-secret-change-me

# Google OAuth (optional - leave empty for local testing)
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
GOOGLE_CALLBACK_URL=http://localhost:3001/api/auth/google/callback

# Email Provider (optional - emails logged to console in dev mode)
EMAIL_PROVIDER=resend
RESEND_API_KEY=
EMAIL_FROM=noreply@localhost

# Session Configuration
SESSION_TTL_MINUTES=60
MAX_CONCURRENT_SESSIONS=3

# Database
DATABASE_PATH=./data/ckad.db

# Frontend Environment Variables
NEXT_PUBLIC_API_URL=http://localhost:3001
NEXT_PUBLIC_WS_URL=ws://localhost:3001
```

## Docker Compose Commands

### Start services
```bash
docker-compose -f docker-compose.local.yml up -d
```

### View logs
```bash
# All services
docker-compose -f docker-compose.local.yml logs -f

# Specific service
docker logs -f ckad-backend-local
docker logs -f ckad-frontend-local
```

### Stop services
```bash
docker-compose -f docker-compose.local.yml down
```

### Rebuild after code changes
```bash
docker-compose -f docker-compose.local.yml up -d --build
```

### Restart a specific service
```bash
docker-compose -f docker-compose.local.yml restart backend
docker-compose -f docker-compose.local.yml restart frontend
```

### Execute commands in containers
```bash
# Backend shell
docker-compose -f docker-compose.local.yml exec backend sh

# Run database seed
docker-compose -f docker-compose.local.yml exec backend node src/db/seed.js
```

## Testing

### Test Login

The platform includes a test login endpoint for local development:

```bash
curl -X POST http://localhost:3001/api/auth/test-login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123"}'
```

### Test API Endpoints

```bash
# Health check
curl http://localhost:3001/healthz

# Get tasks
curl http://localhost:3001/api/tasks \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## Troubleshooting

### Services won't start

1. **Check Docker is running**:
   ```bash
   docker ps
   ```

2. **Check port availability**:
   ```bash
   # Linux/Mac
   lsof -i :3000
   lsof -i :3001
   
   # Or use netstat
   netstat -an | grep 3000
   ```

3. **Check logs**:
   ```bash
   docker-compose -f docker-compose.local.yml logs
   ```

### Backend crashes

1. **Check backend logs**:
   ```bash
   docker logs ckad-backend-local
   ```

2. **Verify Docker socket access**:
   ```bash
   docker-compose -f docker-compose.local.yml exec backend ls -la /var/run/docker.sock
   ```

3. **Check database**:
   ```bash
   ls -la data/ckad.db
   ```

### Frontend not loading

1. **Check frontend logs**:
   ```bash
   docker logs ckad-frontend-local
   ```

2. **Verify API URL**:
   - Check browser console for errors
   - Verify `NEXT_PUBLIC_API_URL` in `.env` matches backend URL

3. **Rebuild frontend**:
   ```bash
   docker-compose -f docker-compose.local.yml up -d --build frontend
   ```

### KIND clusters not starting

1. **Check Docker resources**:
   ```bash
   docker system df
   docker stats
   ```

2. **Verify KIND is installed in backend container**:
   ```bash
   docker-compose -f docker-compose.local.yml exec backend kind version
   ```

3. **Check available memory**:
   - Each KIND cluster needs ~2GB RAM
   - Ensure Docker has enough resources allocated

## Development Workflow

### Making Code Changes

1. **Backend changes**:
   ```bash
   # Rebuild and restart
   docker-compose -f docker-compose.local.yml up -d --build backend
   ```

2. **Frontend changes**:
   ```bash
   # Rebuild and restart
   docker-compose -f docker-compose.local.yml up -d --build frontend
   ```

### Database Changes

```bash
# Access database
docker-compose -f docker-compose.local.yml exec backend sh
sqlite3 /app/data/ckad.db

# Reset database (WARNING: deletes all data)
rm data/ckad.db
docker-compose -f docker-compose.local.yml exec backend node src/db/seed.js
```

## Cleanup

### Stop and remove containers
```bash
docker-compose -f docker-compose.local.yml down
```

### Remove volumes (deletes database)
```bash
docker-compose -f docker-compose.local.yml down -v
```

### Clean up KIND clusters
```bash
# List clusters
docker-compose -f docker-compose.local.yml exec backend kind get clusters

# Delete a cluster
docker-compose -f docker-compose.local.yml exec backend kind delete cluster --name ckad-xxx
```

### Full cleanup
```bash
# Stop services
docker-compose -f docker-compose.local.yml down -v

# Remove images
docker rmi ckad-platform-backend ckad-platform-frontend ckad-terminal:latest

# Clean up orphaned containers
docker container prune -f
```

## Differences from Production

The local setup differs from production in these ways:

1. **No Nginx**: Services are accessed directly on ports 3000 and 3001
2. **Development mode**: Backend runs in development mode with more verbose logging
3. **Simplified auth**: Test login works without email/Google OAuth
4. **Local database**: SQLite database stored in `./data/` directory
5. **No SSL**: HTTP only (no HTTPS)

## Next Steps

- Read the main [README.md](README.md) for architecture details
- Check [DEPLOYMENT-PLAN.md](DEPLOYMENT-PLAN.md) for production deployment
- Review API documentation in `backend/README.md`

